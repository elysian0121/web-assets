async function initSystem() {
    try {
        if (typeof __firebase_config !== 'undefined' && __firebase_config) {
            const config = JSON.parse(__firebase_config);
            firebase.initializeApp(config);
            auth = firebase.auth();
            db = firebase.firestore();
            appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            firebaseEnabled = true;

            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await auth.signInWithCustomToken(__initial_auth_token);
            } else {
                await auth.signInAnonymously();
            }

            auth.onAuthStateChanged((user) => {
                if (user) {
                    currentUser = user;
                    clearTimeout(safetyTimer);
                    startBtn.disabled = false;
                    startBtn.textContent = "開始遊戲";
                    highscoreText.textContent = "系統就緒 (雲端模式)";
                    loadHighScore();
                }
            });
        } else {
            throw new Error("Local Environment");
        }
    } catch (e) {
        console.warn("系統初始化失敗，進入離線模式:", e.message);
        firebaseEnabled = false;
        clearTimeout(safetyTimer);
        // ✅ 關鍵修正：保持按鈕禁用，顯示明確訊息
        startBtn.disabled = true;
        startBtn.textContent = "無法啟動";
        highscoreText.textContent = "❌ 系統初始化失敗 - 離線模式不支援遊玩\n請檢查網路連線後重新整理頁面";
    }
}

// ✅ 移除 safetyTimer（刪除這段）
// const safetyTimer = setTimeout(() => {
//     if (startBtn.disabled) {
//         enableStartButton("連線逾時，進入離線模式");
//     }
// }, 5000);
